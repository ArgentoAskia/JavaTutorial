## Excel操作

`Excel`说起来大家并不陌生，作为微软出品的电子表格软件，用`「工作簿 → 工作表 → 单元格」`三层结构把数据存成`.xls/.xlsx`文件，并内置公式、图表、透视表等快速计算与可视化能力。

常见的`Excel`基本有两种格式：

- `.xls`：`2003`及以前，二进制复合文档，最大`65536`行`256`列。
- `.xlsx`：`2007`及以后，`ZIP`包内嵌`XML`（`OOXML`标准），最大`1048576`行`16384`列。

遵循工作簿(`Workbook`，即一个`Excel`文件) ▶ 工作表(`Sheet`，`Excel`文件底部的`sheet`) ▶ 行(`Row`) ▶ 单元格(`Cell`)，单元格可存「值/公式/样式/批注/数据验证/条件格式」。

### xls文件格式简介

OLE2 + DIFF

### xlsx文件格式

OOXML（ZIP+XML） 

// 吃瓜



### 一句话总结

说白了处理`Excel`实际上就和我们在记事本中编写文本一样，只不过在此基础上我们要遵循`Excel`的文件格式，插入的是二进制数据而非易读的文本而已。理论上只要对文件结构熟悉，我们甚至可以自行处理二进制数据。

## Java处理Excel的库

在`Java`中，常用的处理`Excel`的库有`4`个，我们可以总结为一个核心三大组件：一个核心即**Apache POI**，作为最老牌、功能最强大、`API`最丰富的处理库，提供了非常底层的操作`API`，而三大组件即为来自阿里巴巴的`EasyExcel`（现`FastExcel`），轻量级`POI`封装`EasyPOI`，流式解析`OpenXlsx`。

我们会以功能作为导向来向大家介绍这些框架，这些功能基于框架的`How To`来介绍（如果有的话），我们主要将功能分为读、写、操作和扩展四部分，即：

- `Excel`基础读、流式读取
    - `Excel`文件、`Sheet`工作表、行列处理、单元格级
- `Excel`写出（各类类型数据写出）
    - `Excel`文件、`Sheet`工作表、行列处理、单元格级
- `Excel`操作
    - 文件级：新建，保存，加密，只读，属性摘要，模板填充
    - 工作表级：增删`Sheet`，隐藏/保护，分组/分级，冻结窗口，打印区域，重复标题行、批注、超链接、背景图
    - 行列级：宽度/高度、隐藏、锁定、分组、筛选、自动筛选、数据验证（下拉、整数、日期、自定义公式）、条件格式、合并单元格
    - 单元格级：文本、数字、日期、布尔、错误值、空值、富文本、公式、数组公式、命名范围、单元格样式（字体、颜色、边框、填充、旋转、缩进、数据格式）、单元格注释【写操作】、
    - 公式计算：内置`400+`函数、自定义函数、公式审计、循环引用检测、分步求值、缓存/强制重算、`R1C1`标记
    - 图表与图形：柱状/折线/饼图/散点/雷达/组合图、数据标签、趋势线、误差线、次坐标轴、图表模板、形状/文本框/图片/`OfficeArt`
    - 数据透视表：创建透视表、拖放字段、值汇总方式、分组、切片器、时间线、刷新数据源、透视图
- `Excel`高级操作：
    - 大数据与流式：`SXSSF`流式写（百万行无`OOM`）、`XSSFReader + SAX`流式读、临时文件压缩、滑动窗口、缓存刷盘策略
    - 脚本和底层`API`：事件/用户模型混合解析、低层`Record`级`API`（`BIFF`字节）、自定义属性、数字签名、宏存储（`VBA`项目）、`OLE`对象、`ActiveX`控件
    - 文件格式转换：`xls`、`xlsx`、`CSV`

这也是`Excel`提供给我们的常用和不常用的功能。

### Apache POI

作为`Apache`基金会开源项目，`Java`世界里**最主流**的`Microsoft Office`文档读写库，`Apache POI`的全称是`Apache Poor Obfuscation Implementation`，该名字的由来主要调侃微软`xls`格式"混淆得差"。

实际上`Apache POI`并非是仅仅用于处理`Excel`，`Microsoft`主流的办公套件比如`Excel`、`Word`、`PowerPoint`、`Outlook`、`Visio`、`Publisher`基本都支持。

`Apache POI`处理`Excel`主要靠三大子组件：

| 组件      | 格式                | 文件后缀 | 底层标准             |
| :-------- | :------------------ | :------- | :------------------- |
| **HSSF**  | `Excel 97-2003`     | `.xls`   | `OLE2`复合文档       |
| **XSSF**  | `Excel 2007+`       | `.xlsx`  | `OOXML`（`ZIP+XML`） |
| **SXSSF** | `Excel 2007+`、流式 | `.xlsx`  | `OOXML` + 滑动窗口   |

- **HSSF**

    - 纯内存加载，**行上限65536**，列`256`；

    - 适合旧系统、小文件、兼容性要求。

- **XSSF**

    - 纯内存`DOM`，**行上限 1048576**，列`16384`；

    - 功能最全：图表、透视表、条件格式、公式均能玩；

    - 缺点：百万行级数据直接把 **堆内存吃光**（1 行对象 ≈ 1 KB，100 万行 ≈ 1 GB+）。

- **SXSSF**（`Streaming XSSF`）

    - **XSSF 的流式子实现**；

    - 仅保留**滑动窗口**（默认 `100` 行）在内存，旧行写入临时文件并**立即释放**；

    - 内存占用 `< 30 MB` 即可写**千万行**；

    - 代价：
        - 不再支持**随机访问**（`getRow()` 已刷盘的行返回 null）；
        - 部分功能禁用：合并单元格、透视表、图表、富文本批注等；
        - 完成后必须 `workbook.dispose()` 手动清临时文件

| 场景                            | 推荐 API                          |
| :------------------------------ | :-------------------------------- |
| 旧系统只导出`.xls`              | `HSSF`                            |
| 数据 ≤ 几万行、需要图表/透视表  | `XSSF`                            |
| 数据 ≥ 十万行、无图表、内存敏感 | **SXSSF**                         |
| 读取超大文件                    | `XSSF` + `SAX`事件流（非`SXSSF`） |

#### Excel基本读取

